<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a cleaner look in feed/task lists */
        .card-content::-webkit-scrollbar {
            width: 6px;
        }
        .card-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .card-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .card-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">

    <h1 class="text-3xl md:text-4xl font-bold text-center text-indigo-700 mb-10">Patient Wellbeing Dashboard</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
        
        <div class="bg-white shadow-xl rounded-xl p-6 md:p-8 flex flex-col h-[450px]">
            <div class="flex items-center border-b border-gray-200 pb-4 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                <h2 class="text-2xl font-semibold text-gray-800">Prioritized Tasks</h2>
            </div>
            <div class="card-content flex-grow overflow-y-auto">
                <ol id="prioritized-tasks" class="list-decimal list-inside space-y-3">
                    <li class="h-7 bg-slate-200 rounded-md animate-pulse w-full"></li>
                    <li class="h-7 bg-slate-200 rounded-md animate-pulse w-5/6"></li>
                    <li class="h-7 bg-slate-200 rounded-md animate-pulse w-full"></li>
                    <li class="h-7 bg-slate-200 rounded-md animate-pulse w-3/4"></li>
                </ol>
            </div>
        </div>
        
        <div class="bg-white shadow-xl rounded-xl p-6 md:p-8 flex flex-col h-[450px]">
            <div class="flex items-center border-b border-gray-200 pb-4 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <h2 class="text-2xl font-semibold text-gray-800">Live Request Feed</h2>
            </div>
            <div id="request-feed" class="card-content flex-grow overflow-y-auto space-y-3">
                <div class="p-3 bg-slate-200 rounded-lg animate-pulse h-10 w-full"></div>
                <div class="p-3 bg-slate-200 rounded-lg animate-pulse h-10 w-full"></div>
                <div class="p-3 bg-slate-200 rounded-lg animate-pulse h-10 w-full"></div>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 md:p-8 flex flex-col h-[450px]">
            <div class="flex items-center border-b border-gray-200 pb-4 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <h2 class="text-2xl font-semibold text-gray-800">AI Insights & Warnings</h2>
            </div>
            <div id="ai-insights" class="card-content flex-grow overflow-y-auto space-y-4">
                <div class="p-4 bg-slate-200 rounded-lg animate-pulse h-12 w-full"></div>
                <div class="p-4 bg-slate-200 rounded-lg animate-pulse h-12 w-5/6"></div>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-xl p-6 md:p-8 flex flex-col h-[450px]">
            <div class="flex items-center border-b border-gray-200 pb-4 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <h2 class="text-2xl font-semibold text-gray-800">AI Wellbeing Summary</h2>
            </div>
            <div id="patient-status" class="card-content flex-grow space-y-6 pt-4">
                <div id="status-loader">
                    <div class="h-10 bg-slate-200 rounded-md animate-pulse w-full mb-4"></div>
                    <div class="h-24 bg-slate-200 rounded-md animate-pulse w-full"></div>
                </div>
                <div id="status-content" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-medium text-gray-600">Wellbeing Score:</span>
                        <span id="wellbeing-score" class="text-3xl font-bold text-indigo-600">--</span>
                    </div>
                    <div>
                        <span class="text-lg font-medium text-gray-600">AI Rationale:</span>
                        <p id="wellbeing-rationale" class="text-gray-800 mt-2 p-3 bg-slate-50 rounded-md">--</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // This function runs when the page is fully loaded
        document.addEventListener('DOMContentLoaded', () => {

            // Get references to all the dynamic elements on the page
            const taskList = document.getElementById('prioritized-tasks');
            const requestFeed = document.getElementById('request-feed');
            const aiInsights = document.getElementById('ai-insights');
            
            const statusLoader = document.getElementById('status-loader');
            const statusContent = document.getElementById('status-content');
            const wellbeingScore = document.getElementById('wellbeing-score');
            const wellbeingRationale = document.getElementById('wellbeing-rationale');

            let previousTasks = []; // Store the last known tasks to compare

            /**
             * Speaks the given text using the browser's TTS engine.
             * @param {string} text - The text to be spoken.
             */
            function speakText(text) {
                // Check if speech synthesis is supported
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US'; // Set language for better pronunciation
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn('Speech synthesis not supported by this browser.');
                }
            }

            /**
             * This is the main function.
             * It fetches the latest data from your Flask backend.
             */
            async function fetchData() {
                try {
                    // This is the API endpoint you must create in Flask
                    const response = await fetch('/api/dashboard-data');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // --- Update each section of the dashboard ---
                    updateTasks(data.prioritized_tasks);
                    updateFeed(data.request_feed);
                    updateInsights(data.ai_insights);
                    updateWellbeing(data.wellbeing_summary);

                } catch (error) {
                    console.error('Error fetching dashboard data:', error);
                    // Show an error on the dashboard
                    taskList.innerHTML = '<li class="text-red-600 font-medium">Error connecting to backend.</li>';
                    requestFeed.innerHTML = '<p class="text-red-600 font-medium">Error connecting to backend.</p>';
                    aiInsights.innerHTML = '<p class="text-red-600 font-medium">Error connecting to backend.</p>';
                }
            }
            
            // Helper function to get urgency colors for Tailwind
            function getUrgencyClasses(priorityLevel) {
                if (!priorityLevel) return 'border-l-4 border-gray-400 bg-gray-50';
                
                switch (priorityLevel.toLowerCase()) {
                    case 'high':
                        return 'border-l-4 border-red-600 bg-red-50 text-red-900 font-medium';
                    case 'medium':
                        return 'border-l-4 border-amber-500 bg-amber-50 text-amber-900 font-medium';
                    case 'low':
                        return 'border-l-4 border-blue-600 bg-blue-50 text-blue-900';
                    default:
                        return 'border-l-4 border-gray-400 bg-gray-50';
                }
            }

            /**
             * Updates the "Prioritized Tasks" list.
             * @param {Array} tasks - e.g., [{task_description: "Check pain", priority_level: "high"}, ...]
             */
            function updateTasks(tasks) {
                // Ensure tasks is an array, even if null or undefined from the API
                const currentTasks = Array.isArray(tasks) ? tasks : [];

                // --- Text-to-Speech Logic ---
                const newTasks = currentTasks.filter(newTask => 
                    !previousTasks.some(prevTask => 
                        prevTask.task_description === newTask.task_description && 
                        prevTask.priority_level === newTask.priority_level
                    )
                );

                if (newTasks.length > 0) {
                    const topNewTask = newTasks[0];
                    const priority = topNewTask.priority_level || 'new';
                    const textToSpeak = `New ${priority} priority task: ${topNewTask.task_description}`;
                    speakText(textToSpeak);
                }
                
                previousTasks = currentTasks;
                // --- End of TTS Logic ---

                taskList.innerHTML = ''; // Clear the skeleton loader
                if (currentTasks.length === 0) {
                    taskList.innerHTML = '<li class="text-gray-500 italic">No tasks pending.</li>';
                    return;
                }
                currentTasks.forEach(task => {
                    const li = document.createElement('li');
                    li.textContent = task.task_description;
                    li.className = `p-3 rounded-r-md ${getUrgencyClasses(task.priority_level)}`;
                    taskList.appendChild(li);
                });
            }

            /**
            * Updates the "Live Request Feed" log.
            * @param {Array} feedLogs - e.g., [{request_text: "Pain 4/5", timestamp_str: "03:16 PM", urgency: "high"}, ...]
            */
            function updateFeed(feedLogs) {
                requestFeed.innerHTML = ''; // Clear the skeleton loader
                if (!feedLogs || feedLogs.length === 0) {
                    requestFeed.innerHTML = '<p class="text-gray-500 italic">No requests yet.</p>';
                    return;
                }
                // Show newest requests on top
                feedLogs.reverse().forEach(log => {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="font-bold mr-2">[${log.timestamp_str}]</span> ${log.request_text}`;
                    p.className = `p-3 rounded-lg ${getUrgencyClasses(log.urgency)}`;
                    requestFeed.appendChild(p);
                });
            }

            /**
             * Updates the "AI Insights" section.
             * @param {Array} insights - e.g., ["Patient pain rose...", "Mobility needed..."]
             */
            function updateInsights(insights) {
                aiInsights.innerHTML = ''; // Clear the skeleton loader
                if (!insights || insights.length === 0) {
                    aiInsights.innerHTML = '<p class="text-gray-500 italic">No insights generated yet.</p>';
                    return;
                }
                insights.forEach(insight => {
                    const p = document.createElement('p');
                    p.innerHTML = `<span class="font-bold mr-2">ðŸ’¡</span> ${insight}`;
                    p.className = "p-4 bg-indigo-50 rounded-lg text-indigo-800 font-medium";
                    aiInsights.appendChild(p);
                });
            }

            /**
             * Updates the "Patient Wellbeing Summary" card.
             * @param {Object} summary - e.g., {score: 6, rationale: "A single food request..."}
             */
            function updateWellbeing(summary) {
                if (!summary) return; // Don't update if no summary data

                // Hide loader, show content
                statusLoader.style.display = 'none';
                statusContent.classList.remove('hidden');

                // Update score and rationale
                wellbeingScore.textContent = summary.score !== undefined ? `${summary.score} / 10` : '--';
                wellbeingRationale.textContent = summary.rationale || '--';
            }

            // --- Main Execution ---
            
            // 1. Fetch data immediately when the page loads
            fetchData();
            
            // 2. Set up polling to fetch data every 3 seconds (3000 ms)
            setInterval(fetchData, 3000);
        });
    </script>
</body>
</html>